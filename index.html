<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!DOCTYPE html>
    <link href="./css/reset.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100..900&family=Noto+Serif+TC:wght@200..900&family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
        rel="stylesheet">

    <link href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" rel="stylesheet"
        integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">

</head>

<body>
    <section class="addTicket-panel">
        <div class="addTicket-img">
            <img src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/main_img.png?raw=true"
                alt="">
            <img src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/logo.png?raw=true"
                alt="">
        </div>
        <form action="" class="addTicket-form">
            <h1 class="title"><span><i class="fas fa-plus-circle"></i></span>新增旅遊套票</h1>
            <div class="form-group">
                <div class="addTicket-input">
                    <label for="ticketName">套票名稱</label>
                    <input type="text" id="ticketName" placeholder="請填寫套票名稱" name="套票名稱">
                </div>
                <div class="alert-message">
                    <p id="ticketName-message" data-message="套票名稱">
                        <!--    <i class="fas fa-exclamation-circle"></i>
                      <span>必填!</span> -->
                    </p>
                </div>
            </div>
            <div class="form-group">
                <div class="addTicket-input">
                    <label for="ticketImgUrl">圖片網址</label>
                    <input type="text" id="ticketImgUrl" placeholder="請填寫圖片網址" name="圖片網址">
                </div>
                <div class="alert-message">
                    <p id="ticketImgUrl-message" data-message="圖片網址">
                        <!-- <i class="fas fa-exclamation-circle"></i>
                        <span>必填!</span> -->
                    </p>
                </div>
            </div>
            <div class="form-group">
                <div class="addTicket-input">
                    <label for="ticketRegion">景點地區</label>
                    <select id="ticketRegion" name="景點地區">
                        <option value="" disabled selected hidden>請選擇景點地區</option>
                        <!-- <option value="台北">台北</option>
                            <option value="台中">台中</option>
                            <option value="高雄">高雄</option> -->
                    </select>
                </div>
                <div class="alert-message">
                    <p id="ticketRegion-message" data-message="景點地區">
                        <!-- <i class="fas fa-exclamation-circle"></i>
                        <span>必填!</span>   -->
                    </p>
                </div>
            </div>
            <div class="form-group">
                <div class="addTicket-input">
                    <label for="ticketPrice">套票金額</label>
                    <input type="number" id="ticketPrice" placeholder="請填寫套票金額" name="套票金額" min="0">
                </div>
                <div class="alert-message">
                    <p id="ticketPrice-message" data-message="套票金額">
                        <!-- <i class="fas fa-exclamation-circle"></i>
                        <span>必填!</span> -->
                    </p>
                </div>
            </div>
            <div class="form-group">
                <div class="addTicket-input">
                    <label for="ticketNum">套票組數</label>
                    <input type="number" id="ticketNum" placeholder="請填寫套票組數" name="套票組數" min="1">
                </div>
                <div class="alert-message">
                    <p id="ticketNum-message" data-message="套票組數">
                        <!-- <i class="fas fa-exclamation-circle"></i>
                        <span>必填!</span> -->
                    </p>
                </div>
            </div>
            <div class="form-group">
                <div class="addTicket-input">
                    <label for="ticketRate">套票星級</label>
                    <input type="number" id="ticketRate" placeholder="請填寫套票星級" name="套票星級" min="1" max="10">
                </div>
                <div class="alert-message">
                    <p id="ticketRate-message" data-message="套票星級">
                        <!-- <i class="fas fa-exclamation-circle"></i>
                        <span>必填!</span> -->
                    </p>
                </div>
            </div>
            <div class="form-group">
                <div class="addTicket-input">
                    <label for="ticketDescription">套票描述</label>
                    <textarea name="套票描述" id="ticketDescription" placeholder="請填寫套票描述 (限 100 字)"
                        maxlength="101"></textarea>
                </div>
                <div class="alert-message">
                    <p id="ticketDescription-message" data-message="套票描述">
                        <!-- <i class="fas fa-exclamation-circle"></i>
                        <span>必填!</span> -->
                    </p>
                </div>
            </div>
            <input type="button" class="addTicket-btn btn" value="新增套票">
        </form>
    </section>
    <section class="main-content">
        <!-- 搜尋區 -->
        <div class="search-area">
            <select name="" class="regionSearch">
                <!-- <option value="地區搜尋" disabled selected hidden>地區搜尋</option> -->
                <option value="">全部地區</option>
                <!-- <option value="台南">台南</option> -->
            </select>
            <!-- 本次搜尋共 3 筆資料 -->
            <p id="searchResult-text"></p>
        </div>
        <!-- 套票卡片區 -->
        <ul class="ticketCard-area">
            <!-- <li class="ticketCard">
                <div class="ticketCard-img">
                    <a href="#">
                        <img src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/travel_1.png?raw=true"
                            alt="">
                    </a>
                    <div class="ticketCard-region">高雄</div>
                    <div class="ticketCard-rank">10</div>
                </div>
                <div class="ticketCard-content">
                    <div>
                        <h3>
                            <a href="#" class="ticketCard-name">綠島自由行套裝行程</a>
                        </h3>
                        <p class="ticketCard-description">
                            嚴選超高CP值綠島自由行套裝行程，多種綠島套裝組合。
                        </p>
                    </div>
                    <div class="ticketCard-info">
                        <p class="ticketCard-num">
                            <span><i class="fas fa-exclamation-circle"></i></span>
                            剩下最後 <span id="ticketCard-num"> 87 </span> 組
                        </p>
                        <p class="ticketCard-price">
                            TWD <span id="ticketCard-price">$1400</span>
                        </p>
                    </div>
                </div>
            </li>
            <li class="ticketCard">
                <div class="ticketCard-img">
                    <a href="#">
                        <img src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/travel_4.png?raw=true"
                            alt="">
                    </a>
                    <div class="ticketCard-region">台北</div>
                    <div class="ticketCard-rank">2</div>
                </div>
                <div class="ticketCard-content">
                    <div>
                        <h3>
                            <a href="#" class="ticketCard-name">清境高空觀景步道</a>
                        </h3>
                        <p class="ticketCard-description">
                            清境農場青青草原數十公頃碧草，這些景觀豐沛了清境觀景步道的風格，也涵養它無可取代的特色。
                        </p>
                    </div>
                    <div class="ticketCard-info">
                        <div class="ticketCard-num">
                            <p>
                                <span><i class="fas fa-exclamation-circle"></i></span>
                                剩下最後 <span id="ticketCard-num"> 99 </span> 組
                            </p>
                        </div>
                        <p class="ticketCard-price">
                            TWD <span id="ticketCard-price">$240</span>
                        </p>
                    </div>
                </div>
            </li>
            <li class="ticketCard">
                <div class="ticketCard-img">
                    <a href="#">
                        <img src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/travel_3.png?raw=true"
                            alt="">
                    </a>
                    <div class="ticketCard-region">台中</div>
                    <div class="ticketCard-rank">7</div>
                </div>
                <div class="ticketCard-content">
                    <div>
                        <h3>
                            <a href="#" class="ticketCard-name">山林悠遊套票</a>
                        </h3>
                        <p class="ticketCard-description">
                            山林悠遊套票，結合南投清境高空步道、雙龍瀑布七彩吊橋、瑞龍瀑布園區之熱門景點。
                        </p>
                    </div>
                    <div class="ticketCard-info">
                        <div class="ticketCard-num">
                            <p>
                                <span><i class="fas fa-exclamation-circle"></i></span>
                                剩下最後 <span id="ticketCard-num"> 20 </span> 組
                            </p>
                        </div>
                        <p class="ticketCard-price">
                            TWD <span id="ticketCard-price">$1765</span>
                        </p>
                    </div>
                </div>
            </li> -->
        </ul>
        <!-- 查無關鍵字區 -->
        <div class="cantFind-area">
            <h3>查無此關鍵字資料</h3>
            <img src="https://github.com/hexschool/2022-web-layout-training/blob/main/js_week5/no_found.png?raw=true"
                alt="">
        </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        //############data############
        const lv = 0; //0.寫死的data LV1.travelAPI-lv1.json LV2.ravelApi.json
        let areaData = [];
        let data = [];
        //############Selector############
        //form
        const ticketName = document.querySelector('#ticketName');
        const ticketName_message = document.querySelector('#ticketName-message');

        const ticketImgUrl = document.querySelector('#ticketImgUrl');
        const ticketImgUrl_message = document.querySelector('#ticketImgUrl-message');

        const ticketRegion = document.querySelector('#ticketRegion');
        const ticketRegion_message = document.querySelector('#ticketRegion-message');

        const ticketPrice = document.querySelector('#ticketPrice');
        const ticketPrice_message = document.querySelector('#ticketPrice-message');

        const ticketNum = document.querySelector('#ticketNum');
        const ticketNum_message = document.querySelector('#ticketNum-message');

        const ticketRate = document.querySelector('#ticketRate');
        const ticketRate_message = document.querySelector('#ticketRate-message');

        const ticketDescription = document.querySelector('#ticketDescription');
        const ticketDescription_message = document.querySelector('#ticketDescription-message');

        const addTicket_btn = document.querySelector('.addTicket-btn');

        //篩選區
        const regionSearch = document.querySelector('.regionSearch'); // 區域
        const searchResult_text = document.querySelector('#searchResult-text'); //共搜尋幾筆
        const ticketCard_area = document.querySelector('.ticketCard-area'); //資料區
        const cantFind_area = document.querySelector('.cantFind-area'); //查無關鍵字區
        //############function############
        //建立select的option 因為一次給兩個select會有問題
        function createOption(tag, value, html) {
            var opt = document.createElement(tag);
            opt.value = value;
            opt.innerHTML = html;
            return opt;
        }

        //distinct area        
        function addArea(newValue, newAreaName) {
            const arr = areaData.filter(x => x.areaID === newValue);
            if (arr.length == 0) {
                //console.log(`無:${newValue}`);
                areaData.push({ "areaID": newValue, "areaName": newAreaName });
                ticketRegion.appendChild(createOption('option', newValue, newAreaName)); //insertBefore appendChild
                regionSearch.appendChild(createOption('option', newValue, newAreaName));
            } else {
                //console.log(`有:${newValue}`);
            }
            //console.log (areaData);
        }

        //AI
        function isEmpty(value) {
            return !value || value.trim().length === 0;
        }

        //AI
        function isImageUrl(url) {
            const imageRegex = /\.(png|jpg|jpeg|svg|webp|gif|bmp)$/i;
            return imageRegex.test(url);
        }

        //錯誤
        function dataError(obj, objicon, type) {
            let error = "";
            //console.log(obj.value);
            switch (type) {
                case 1: //字串
                    if (isEmpty(obj.value)) { error = "必填!"; }
                    break;
                case 2://圖片連結



                    if (isImageUrl(obj.value) === false) {
                        error = "圖片網址格式錯誤!";
                    }
                    break;
                case 3: //數字     
                    if (isEmpty(obj.value) && isNaN(obj.val)) { error = "必填數字!"; }
                    break;
                case 4: //數字   
                    if (isEmpty(obj.value) || isNaN(obj.value)) {
                        error = "必填數字!";
                    } else if (parseInt(obj.value) < 1 || parseInt(obj.value) > 10) {
                        error = "星級區間是 1-10 分";
                    }
                    break;
                case 5: //數字過多   
                    if (obj.value !== "" && obj.value !== undefined && obj.value.length > 100) { error = "限 100 字"; }
                    break;
            }

            //console.log(error);
            if (error !== "") {
                objicon.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${error}</span>`;
                return 1;
            } else {
                objicon.innerHTML = "";
                return 0;
            }
        }

        //初始化下拉選單
        function initSelect() {
            //有提供其他方式再修改即可
            data.forEach(function (item) {
                addArea(item.area, item.area);
            });
        }

        //搜尋、篩選下拉變換
        function search() {
            const val = regionSearch.value;
            let filterData = [];
            if (val !== '') {
                filterData = data.filter(x => x.area === val);
                //console.log(filterData);
            } else {
                //console.log('全選');
                filterData = data;
            }
            // showHtml(filterData);
            //}

            //產生出篩選後的Html
            //function showHtml(showData) {
            let html = "";
            if (filterData.length > 0) {
                //console.log('>0');
                cantFind_area.style.display = 'none';
                filterData.forEach(function (item) {
                    html += ` 
             <li class="ticketCard">
                <div class="ticketCard-img">
                    <a href="#">
                        <img src="${item.imgUrl}"
                            alt="${item.name}">
                    </a>
                    <div class="ticketCard-region">${item.area}</div>
                    <div class="ticketCard-rank">${item.rate}</div>
                </div>
                <div class="ticketCard-content">
                    <div>
                        <h3>
                            <a href="#" class="ticketCard-name">${item.name}</a>
                        </h3>
                        <p class="ticketCard-description">
                        ${item.description}
                        </p>
                    </div>
                    <div class="ticketCard-info">
                        <p class="ticketCard-num">
                            <span><i class="fas fa-exclamation-circle"></i></span>
                            剩下最後 <span id="ticketCard-num"> ${item.group} </span> 組
                        </p>
                        <p class="ticketCard-price">
                            TWD <span id="ticketCard-price">$${item.price}</span>
                        </p>
                    </div>
                </div>
             </li>`;
                });
            } else {
                cantFind_area.style.display = 'block';
            }
            ticketCard_area.innerHTML = html;
            searchResult_text.textContent = `本次搜尋共 ${filterData.length} 筆資料`;
        }

        function init() {

            switch (lv) {
                default:
                case 0:

                    data = [
                        {
                            "id": 0,
                            "name": "肥宅心碎賞櫻3日",
                            "imgUrl": "https://images.unsplash.com/photo-1522383225653-ed111181a951?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=1655&q=80",
                            "area": "高雄",
                            "description": "賞櫻花最佳去處。肥宅不得不去的超讚景點！",
                            "group": 87,
                            "price": 1400,
                            "rate": 10
                        },
                        {
                            "id": 1,
                            "name": "貓空纜車雙程票",
                            "imgUrl": "https://images.unsplash.com/photo-1501393152198-34b240415948?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=1650&q=80",
                            "area": "台北",
                            "description": "乘坐以透明強化玻璃為地板的「貓纜之眼」水晶車廂，享受騰雲駕霧遨遊天際之感",
                            "group": 99,
                            "price": 240,
                            "rate": 2
                        },
                        {
                            "id": 2,
                            "name": "台中谷關溫泉會1日",
                            "imgUrl": "https://images.unsplash.com/photo-1535530992830-e25d07cfa780?ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&ixlib=rb-1.2.1&auto=format&fit=crop&w=1650&q=80",
                            "area": "台中",
                            "description": "全館客房均提供谷關無色無味之優質碳酸原湯，並取用八仙山之山冷泉供蒞臨貴賓沐浴及飲水使用。",
                            "group": 20,
                            "price": 1765,
                            "rate": 7
                        }
                    ];

                    initSelect(); //初始化下拉跑一次
                    search(); //先讓他搜尋一次會全部出來
                    break
                case 1:
                    axios.get('https://raw.githubusercontent.com/hexschool/js-training/main/travelAPI-lv1.json')
                        .then(function (response) {
                            if (response.status === 200) {
                                data = response.data;
                                //console.log(data);
                                initSelect(); //初始化下拉跑一次
                                search(); //先讓他搜尋一次會全部出來
                            }
                        });
                    break;
                case 2:
                    axios.get('https://raw.githubusercontent.com/hexschool/js-training/main/travelApi.json')
                        .then(function (response) {
                            if (response.status === 200) {
                                data = response.data.data;
                                initSelect(); //初始化下拉跑一次
                                search(); //先讓他搜尋一次會全部出來
                            }
                        });
                    break;
            }
        }

        function addData() {

            //驗證錯誤
            let errorCount = 0;
            errorCount += dataError(ticketName, ticketName_message, 1);
            errorCount += dataError(ticketImgUrl, ticketImgUrl_message, 2);
            errorCount += dataError(ticketRegion, ticketRegion_message, 1);
            errorCount += dataError(ticketPrice, ticketPrice_message, 3);
            errorCount += dataError(ticketNum, ticketNum_message, 3);
            errorCount += dataError(ticketRate, ticketRate_message, 4);
            errorCount += dataError(ticketDescription, ticketDescription_message, 5);
            if (errorCount > 0) return;

            //組資料
            //console.log('都沒錯');
            //https://www.danvega.dev/blog/find-max-array-objects-javascript
            const maxId = Math.max(...data.map(x => x.id));

            const createData = {
                "id": maxId + 1,
                "name": ticketName.value,
                "imgUrl": ticketImgUrl.value,
                "area": ticketRegion.value,
                "price": ticketPrice.value,
                "group": ticketNum.value,
                "rate": ticketRate.value,
                "description": ticketDescription.value
            }

            //寫入暫存的data
            data.push(createData);
            //寫入資料庫

            //加入看看有沒有下拉
            addArea(createData.area, createData.area);

            search();

        }
        //############addEventListener############        
        regionSearch.addEventListener('change', function () {
            search();
        });

        addTicket_btn.addEventListener('click', function () {
            addData();
        });

        //############Init############
        init();
        //############本次任務############
        //地區用 change 監聽  -ok
        //上方新增的地區跟下方篩選的地區都寫死選項（依照目前提供的 JSON data area 欄位）  -ok
        //地區的篩選下拉需要加上『全部地區』option  -ok
        //#ticketRegion 區域 form
        //.regionSearch 區域 篩選

        //預設資料為 3 筆（內容需依照目前提供的 JSON data）-ok
        //篩選後會顯示『搜尋資料為 ? 筆』  -ok

        // 描述欄位使用 textarea -ok
        // 星級區間是 1-10 分 -ok
        // 金額、組數、星級的 type 為 Number -ok
    </script>
</body>

</html>